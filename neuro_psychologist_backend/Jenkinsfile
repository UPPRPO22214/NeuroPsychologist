pipeline {
    agent any
    
    environment {
        MAVEN_OPTS = '-Xmx1024m'
        // AI API Configuration - —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —ç—Ç–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ Jenkins
        AI_API_KEY = credentials('ai-api-key')
        AI_FOLDER_ID = credentials('ai-folder-id')
        AI_KEY_ID = credentials('ai-key-id')
        SERVER_PORT = '8081'
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo 'Checking out source code...'
                checkout scm
                echo 'Making Maven wrapper executable...'
                sh 'chmod +x neuro_psychologist_backend/mvnw'
            }
        }
        
        stage('Build Info') {
            steps {
                echo 'Displaying build information...'
                sh 'java -version'
                dir('neuro_psychologist_backend') {
                    sh './mvnw -version'
                }
                sh 'echo "Building neuro_psychologist_backend version: 0.0.1-SNAPSHOT"'
            }
        }
        
        stage('Clean & Compile') {
            steps {
                echo 'Cleaning and compiling the project...'
                dir('neuro_psychologist_backend') {
                    sh './mvnw clean compile'
                }
            }
        }
        
        stage('Test') {
            steps {
                echo 'Running unit tests...'
                dir('neuro_psychologist_backend') {
                    sh './mvnw test'
                }
            }
            post {
                always {
                    junit testResults: 'neuro_psychologist_backend/target/surefire-reports/*.xml', allowEmptyResults: true
                    archiveArtifacts artifacts: 'neuro_psychologist_backend/target/surefire-reports/**/*', allowEmptyArchive: true
                }
            }
        }
        
        stage('Package') {
            steps {
                echo 'Packaging the application...'
                dir('neuro_psychologist_backend') {
                    sh './mvnw package -DskipTests'
                }
            }
            post {
                success {
                    archiveArtifacts artifacts: 'neuro_psychologist_backend/target/*.jar', fingerprint: true
                }
            }
        }
        
        stage('Verify') {
            steps {
                echo 'Verifying the build...'
                dir('neuro_psychologist_backend') {
                    sh 'ls -la target/'
                    sh 'file target/*.jar || echo "JAR file verification skipped"'
                }
            }
        }
        
        stage('Deploy Locally') {
            when {
                anyOf {
                    branch 'main'
                    branch 'develop'
                }
            }
            steps {
                echo 'Deploying application locally...'
                script {
                    dir('neuro_psychologist_backend') {
                        sh '''
                            # –°–æ–∑–¥–∞—ë–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
                            mkdir -p /var/jenkins_home/apps/neuropsychologist
                            
                            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –ø—Ä–æ—Ü–µ—Å—Å –µ—Å–ª–∏ –æ–Ω –∑–∞–ø—É—â–µ–Ω
                            echo "Stopping previous application instance..."
                            pkill -f "app.jar" || echo "No app.jar process found"
                            sleep 3

                            # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                            pkill -9 -f "app.jar" || echo "No app.jar process to kill forcefully"
                            sleep 2
                            
                            # –ö–æ–ø–∏—Ä—É–µ–º –Ω–æ–≤—ã–π JAR —Ñ–∞–π–ª
                            cp target/neuro_psychologist_backend-0.0.1-SNAPSHOT.jar /var/jenkins_home/apps/neuropsychologist/app.jar
                            
                            # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
                            cd /var/jenkins_home/apps/neuropsychologist
                            echo "Starting application on port 8081..."
                            
                            # –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –¥–ª—è –≤–Ω–µ—à–Ω–µ–≥–æ –¥–æ—Å—Ç—É–ø–∞
                            nohup java -jar app.jar \
                                --server.port=8081 \
                                --server.address=0.0.0.0 \
                                --management.endpoints.web.exposure.include=health,info \
                                --management.endpoint.health.show-details=always \
                                > app.log 2>&1 &
                            APP_PID=$!
                            echo "Application started with PID: $APP_PID on port 8081"
                            echo "External URL: http://158.160.203.252:8081"
                            
                            # –°–æ—Ö—Ä–∞–Ω—è–µ–º PID –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
                            echo $APP_PID > app.pid
                            
                            # –ñ–¥—ë–º –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
                            echo "Waiting for application to start..."
                            sleep 30
                            
                            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—Å—Ç–∏–ª–æ—Å—å
                            for i in $(seq 1 15); do
                                echo "Attempt $i/15: Checking application health..."
                                
                                # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π endpoint
                                if curl -f http://localhost:8081/api/health 2>/dev/null; then
                                    echo "‚úÖ Application API is healthy on port 8081!"
                                    echo "üåê External access: http://158.160.203.252:8081"
                                    echo "üìä API Health: http://158.160.203.252:8081/api/health"
                                    echo "üìä Actuator Health: http://158.160.203.252:8081/actuator/health"
                                    break
                                # –ï—Å–ª–∏ –æ—Å–Ω–æ–≤–Ω–æ–π endpoint –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –ø—Ä–æ–≤–µ—Ä—è–µ–º actuator
                                elif curl -f http://localhost:8081/actuator/health 2>/dev/null; then
                                    echo "‚ö†Ô∏è Actuator is healthy but API endpoint may have issues"
                                    echo "üåê External access: http://158.160.203.252:8081"
                                    echo "üìä Actuator Health: http://158.160.203.252:8081/actuator/health"
                                    break
                                elif [ $i -eq 15 ]; then
                                    echo "‚ùå Application failed to start properly"
                                    echo "=== Application logs ==="
                                    tail -50 /var/jenkins_home/apps/neuropsychologist/app.log
                                    echo "=== Process status ==="
                                    ps aux | grep java | grep neuro_psychologist || echo "No java process found"
                                    exit 1
                                else
                                    echo "Application not ready yet, waiting..."
                                    sleep 10
                                fi
                            done
                        '''
                    }
                }
            }
            post {
                success {
                    echo '‚úÖ Application successfully deployed!'
                    echo 'üåê External URL: http://158.160.203.252:8081'
                    echo 'üìä Health check: http://158.160.203.252:8081/actuator/health'
                }
                failure {
                    echo '‚ùå Deployment failed! Check application logs:'
                    sh 'tail -100 /var/jenkins_home/apps/neuropsychologist/app.log || echo "No log file found"'
                }
            }
        }
    }
    
    post {
        always {
            echo 'Pipeline execution completed.'
        }
        
        success {
            echo '‚úÖ Pipeline executed successfully!'
        }
        
        failure {
            echo '‚ùå Pipeline failed! Check the logs for details.'
        }
        
        unstable {
            echo '‚ö†Ô∏è Pipeline is unstable! Some tests may have failed.'
        }
    }
}