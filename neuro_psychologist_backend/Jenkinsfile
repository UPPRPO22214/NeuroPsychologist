pipeline {
    agent any
    
    environment {
        MAVEN_OPTS = '-Xmx1024m'
        // AI API Configuration - —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —ç—Ç–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ Jenkins
        AI_API_KEY = credentials('ai-api-key')
        AI_FOLDER_ID = credentials('ai-folder-id')
        AI_KEY_ID = credentials('ai-key-id')
        
        // Database Configuration
        DATABASE_URL = credentials('database-url')
        DATABASE_USERNAME = credentials('database-username')
        DATABASE_PASSWORD = credentials('database-password')
        
        // JWT Configuration
        JWT_SECRET = credentials('jwt-secret')
        
        // Application Configuration
        SERVER_PORT = '8081'
        DOCKER_IMAGE_NAME = 'neuroapp'
        CONTAINER_NAME = 'neuroapp'
        EXTERNAL_IP = '158.160.203.252'
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo 'Checking out source code...'
                checkout scm
                echo 'Making Maven wrapper executable...'
                sh 'chmod +x neuro_psychologist_backend/mvnw'
            }
        }
        
        stage('Build Info') {
            steps {
                echo 'Displaying build information...'
                sh 'java -version'
                dir('neuro_psychologist_backend') {
                    sh './mvnw -version'
                }
                sh 'echo "Building neuro_psychologist_backend version: 0.0.1-SNAPSHOT"'
                sh 'docker --version || echo "Docker not available"'
            }
        }
        
        stage('Clean & Compile') {
            steps {
                echo 'Cleaning and compiling the project...'
                dir('neuro_psychologist_backend') {
                    sh './mvnw clean compile'
                }
            }
        }
        
        stage('Test') {
            steps {
                echo 'Running unit tests...'
                dir('neuro_psychologist_backend') {
                    sh './mvnw test'
                }
            }
            post {
                always {
                    junit testResults: 'neuro_psychologist_backend/target/surefire-reports/*.xml', allowEmptyResults: true
                    archiveArtifacts artifacts: 'neuro_psychologist_backend/target/surefire-reports/**/*', allowEmptyArchive: true
                }
            }
        }
        
        stage('Package') {
            steps {
                echo 'Packaging the application...'
                dir('neuro_psychologist_backend') {
                    sh './mvnw package -DskipTests'
                }
            }
            post {
                success {
                    archiveArtifacts artifacts: 'neuro_psychologist_backend/target/*.jar', fingerprint: true
                }
            }
        }
        
        stage('Verify') {
            steps {
                echo 'Verifying the build...'
                dir('neuro_psychologist_backend') {
                    sh 'ls -la target/'
                    sh 'file target/*.jar || echo "JAR file verification skipped"'
                }
            }
        }
        
        stage('Build Docker Image') {
            steps {
                script {
                    echo 'Building Docker image...'
                    dir('neuro_psychologist_backend') {
                        sh """
                            docker build -t ${DOCKER_IMAGE_NAME}:latest .
                            docker tag ${DOCKER_IMAGE_NAME}:latest ${DOCKER_IMAGE_NAME}:${BUILD_NUMBER}
                        """
                    }
                }
            }
        }
        
        stage('Deploy') {
            steps {
                script {
                    echo 'Deploying application...'
                    sh """
                        # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏ —É–¥–∞–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –µ—Å–ª–∏ –µ—Å—Ç—å
                        docker stop ${CONTAINER_NAME} || true
                        docker rm ${CONTAINER_NAME} || true
                        
                        # –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
                        docker run -d \
                            --name ${CONTAINER_NAME} \
                            --restart unless-stopped \
                            -p ${SERVER_PORT}:${SERVER_PORT} \
                            -e SERVER_PORT=${SERVER_PORT} \
                            -e YANDEX_API_KEY=\${AI_API_KEY} \
                            -e AI_FOLDER_ID=\${AI_FOLDER_ID} \
                            -e AI_KEY_ID=\${AI_KEY_ID} \
                            -e DATABASE_URL=\${DATABASE_URL} \
                            -e DATABASE_USERNAME=\${DATABASE_USERNAME} \
                            -e DATABASE_PASSWORD=\${DATABASE_PASSWORD} \
                            -e JWT_SECRET=\${JWT_SECRET} \
                            -e SPRING_PROFILES_ACTIVE=prod \
                            ${DOCKER_IMAGE_NAME}:latest
                        
                        # –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
                        echo "Waiting for application to start..."
                        sleep 15
                        
                        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
                        docker ps | grep ${CONTAINER_NAME}
                    """
                }
            }
            post {
                success {
                    echo '‚úÖ Application successfully deployed!'
                    echo "üåê External URL: http://${EXTERNAL_IP}:${SERVER_PORT}"
                    echo "üìä Health check: http://${EXTERNAL_IP}:${SERVER_PORT}/actuator/health"
                    echo "üîç API docs: http://${EXTERNAL_IP}:${SERVER_PORT}/swagger-ui.html"
                }
                failure {
                    echo '‚ùå Deployment failed! Check application logs:'
                    sh "docker logs ${CONTAINER_NAME} || echo 'No container logs found'"
                }
            }
        }
        
        stage('Health Check') {
            steps {
                script {
                    echo 'Performing health check...'
                    sh """
                        # –ñ–¥–µ–º –ø–æ–ª–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
                        sleep 10
                        
                        # –ü—Ä–æ–≤–µ—Ä—è–µ–º health endpoint
                        for i in {1..10}; do
                            if curl -f http://localhost:${SERVER_PORT}/actuator/health; then
                                echo "‚úÖ Health check passed!"
                                exit 0
                            fi
                            echo "Attempt \$i failed, retrying in 5 seconds..."
                            sleep 5
                        done
                        
                        echo "‚ùå Health check failed after 10 attempts"
                        docker logs ${CONTAINER_NAME}
                        exit 1
                    """
                }
            }
        }
        
        stage('Cleanup Old Images') {
            steps {
                script {
                    echo 'Cleaning up old Docker images...'
                    sh """
                        # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–∑—ã, –æ—Å—Ç–∞–≤–ª—è—è –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3
                        docker images ${DOCKER_IMAGE_NAME} --format "{{.ID}} {{.Tag}}" | \
                        grep -v latest | \
                        tail -n +4 | \
                        awk '{print \$1}' | \
                        xargs -r docker rmi || true
                        
                        # –£–¥–∞–ª—è–µ–º dangling images
                        docker image prune -f || true
                    """
                }
            }
        }
    }
    
    post {
        always {
            echo 'Pipeline execution completed.'
            sh """
                echo "=== Container Status ==="
                docker ps -a | grep ${CONTAINER_NAME} || echo "Container not found"
                
                echo "=== Recent Logs ==="
                docker logs --tail 50 ${CONTAINER_NAME} || echo "No logs available"
            """
        }
        success {
            echo '‚úÖ Pipeline executed successfully!'
            echo "üöÄ Application is running at http://${EXTERNAL_IP}:${SERVER_PORT}"
        }
        failure {
            echo '‚ùå Pipeline failed! Check the logs for details.'
            sh "docker logs ${CONTAINER_NAME} || echo 'No container logs available'"
        }
        unstable {
            echo '‚ö†Ô∏è Pipeline is unstable! Some tests may have failed.'
        }
    }
}