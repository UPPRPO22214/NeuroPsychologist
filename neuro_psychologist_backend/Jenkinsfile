pipeline {
    agent any
    
    environment {
        MAVEN_OPTS = '-Xmx1024m'
        // AI API Configuration - —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —ç—Ç–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ Jenkins
        AI_API_KEY = credentials('ai-api-key')
        AI_FOLDER_ID = credentials('ai-folder-id')
        AI_KEY_ID = credentials('ai-key-id')
        SERVER_PORT = '8081'
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo 'Checking out source code...'
                checkout scm
                echo 'Making Maven wrapper executable...'
                sh 'chmod +x neuro_psychologist_backend/mvnw'
            }
        }
        
        stage('Build Info') {
            steps {
                echo 'Displaying build information...'
                sh 'java -version'
                dir('neuro_psychologist_backend') {
                    sh './mvnw -version'
                }
                sh 'echo "Building neuro_psychologist_backend version: 0.0.1-SNAPSHOT"'
            }
        }
        
        stage('Clean & Compile') {
            steps {
                echo 'Cleaning and compiling the project...'
                dir('neuro_psychologist_backend') {
                    sh './mvnw clean compile'
                }
            }
        }
        
        stage('Test') {
            steps {
                echo 'Running unit tests...'
                dir('neuro_psychologist_backend') {
                    sh './mvnw test'
                }
            }
            post {
                always {
                    junit testResults: 'neuro_psychologist_backend/target/surefire-reports/*.xml', allowEmptyResults: true
                    archiveArtifacts artifacts: 'neuro_psychologist_backend/target/surefire-reports/**/*', allowEmptyArchive: true
                }
            }
        }
        
        stage('Package') {
            steps {
                echo 'Packaging the application...'
                dir('neuro_psychologist_backend') {
                    sh './mvnw package -DskipTests'
                }
            }
            post {
                success {
                    archiveArtifacts artifacts: 'neuro_psychologist_backend/target/*.jar', fingerprint: true
                }
            }
        }
        
        stage('Verify') {
            steps {
                echo 'Verifying the build...'
                dir('neuro_psychologist_backend') {
                    sh 'ls -la target/'
                    sh 'file target/*.jar || echo "JAR file verification skipped"'
                }
            }
        }
        
        stage('Deploy Locally') {
            steps {
                echo 'Deploying application locally...'
                script {
                    def currentBranch = env.BRANCH_NAME
                    if (currentBranch == 'main' || currentBranch == 'develop') {
                        dir('neuro_psychologist_backend') {
                            sh '''
                                mkdir -p /var/jenkins_home/apps/neuropsychologist
                                
                                echo "Stopping previous application instance..."
                                pkill -f "app.jar" || echo "No previous instance found"
                                sleep 3
                                pkill -9 -f "app.jar" || echo "No process to kill forcefully"
                                sleep 2
                                
                                cp target/neuro_psychologist_backend-0.0.1-SNAPSHOT.jar /var/jenkins_home/apps/neuropsychologist/app.jar
                                
                                cd /var/jenkins_home/apps/neuropsychologist
                                echo "Starting application on port 8081..."
                                
                                export YANDEX_API_KEY="$AI_API_KEY"
                                export AI_FOLDER_ID="$AI_FOLDER_ID"
                                export AI_KEY_ID="$AI_KEY_ID"
                                
                                # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º screen –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
                                apt update && apt install -y screen || echo "Screen installation failed, using nohup"
                                
                                # –ó–∞–ø—É—Å–∫–∞–µ–º –≤ screen —Å–µ—Å—Å–∏–∏
                                screen -S neuroapp -dm java -jar app.jar \
                                    --server.port=8081 \
                                    --server.address=0.0.0.0 \
                                    --management.endpoints.web.exposure.include=health,info \
                                    --management.endpoint.health.show-details=always
                                
                                echo "Application started in screen session"
                                sleep 15
                                
                                if ps aux | grep app.jar | grep -v grep; then
                                    echo "‚úÖ Application process is running"
                                else
                                    echo "‚ùå Application process failed to start with screen"
                                    echo "Trying alternative startup method..."
                                    
                                    nohup java -jar app.jar \
                                        --server.port=8081 \
                                        --server.address=0.0.0.0 \
                                        --management.endpoints.web.exposure.include=health,info \
                                        --management.endpoint.health.show-details=always \
                                        > app.log 2>&1 &
                                    
                                    sleep 10
                                    if ps aux | grep app.jar | grep -v grep; then
                                        echo "‚úÖ Application started with nohup"
                                    else
                                        echo "‚ùå All startup methods failed"
                                        tail -50 app.log
                                        exit 1
                                    fi
                                fi
                                
                                echo "Checking application health..."
                                for i in $(seq 1 10); do
                                    if curl -f -s http://localhost:8081/api/health > /dev/null; then
                                        echo "‚úÖ Application API is healthy on port 8081!"
                                        echo "üåê External URL: http://158.160.203.252:8081"
                                        echo "üìä API Health: http://158.160.203.252:8081/api/health"
                                        echo "üìä Actuator Health: http://158.160.203.252:8081/actuator/health"
                                        break
                                    elif [ $i -eq 10 ]; then
                                        echo "‚ùå Application not responding after 10 attempts"
                                        tail -50 app.log
                                        ps aux | grep app.jar || echo "No app.jar process found"
                                        netstat -tlnp | grep 8081 || echo "Port 8081 not listening"
                                        exit 1
                                    else
                                        echo "Attempt $i/10: Application not ready yet, waiting..."
                                        sleep 5
                                    fi
                                done
                            '''
                        }
                    } else {
                        echo "Skipping deployment for branch: ${currentBranch}"
                    }
                }
            }
            post {
                success {
                    echo '‚úÖ Application successfully deployed!'
                    echo 'üåê External URL: http://158.160.203.252:8081'
                    echo 'üìä Health check: http://158.160.203.252:8081/actuator/health'
                }
                failure {
                    echo '‚ùå Deployment failed! Check application logs:'
                    sh 'tail -100 /var/jenkins_home/apps/neuropsychologist/app.log || echo "No log file found"'
                }
            }
        }
    }
    
    post {
        always {
            echo 'Pipeline execution completed.'
        }
        success {
            echo '‚úÖ Pipeline executed successfully!'
        }
        failure {
            echo '‚ùå Pipeline failed! Check the logs for details.'
        }
        unstable {
            echo '‚ö†Ô∏è Pipeline is unstable! Some tests may have failed.'
        }
    }
}