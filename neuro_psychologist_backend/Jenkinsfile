pipeline {
    agent any
    
    environment {
        MAVEN_OPTS = '-Xmx1024m'
        AI_API_KEY = credentials('ai-api-key')
        AI_FOLDER_ID = credentials('ai-folder-id')
        AI_KEY_ID = credentials('ai-key-id')
        SERVER_PORT = '8081'
    }

    stages {
        stage('Checkout') {
            steps {
                echo 'Checking out source code...'
                checkout scm
                echo 'Making Maven wrapper executable...'
                sh 'chmod +x neuro_psychologist_backend/mvnw'
            }
        }

        stage('Build Info') {
            steps {
                echo 'Displaying build information...'
                sh 'java -version'
                dir('neuro_psychologist_backend') {
                    sh './mvnw -version'
                }
                sh 'echo "Building neuro_psychologist_backend version: 0.0.1-SNAPSHOT"'
            }
        }

        stage('Clean & Compile') {
            steps {
                echo 'Cleaning and compiling the project...'
                dir('neuro_psychologist_backend') {
                    sh './mvnw clean compile'
                }
            }
        }

        stage('Test') {
            steps {
                echo 'Running unit tests...'
                dir('neuro_psychologist_backend') {
                    sh './mvnw test'
                }
            }
            post {
                always {
                    junit testResults: 'neuro_psychologist_backend/target/surefire-reports/*.xml', allowEmptyResults: true
                    archiveArtifacts artifacts: 'neuro_psychologist_backend/target/surefire-reports/**/*', allowEmptyArchive: true
                }
            }
        }

        stage('Package') {
            steps {
                echo 'Packaging the application...'
                dir('neuro_psychologist_backend') {
                    sh './mvnw package -DskipTests'
                }
            }
            post {
                success {
                    archiveArtifacts artifacts: 'neuro_psychologist_backend/target/*.jar', fingerprint: true
                }
            }
        }

        stage('Verify') {
            steps {
                echo 'Verifying the build...'
                dir('neuro_psychologist_backend') {
                    sh 'ls -la target/'
                    sh 'file target/*.jar || echo "JAR file verification skipped"'
                }
            }
        }

        stage('Deploy Locally') {
            steps {
                script {
                    dir('neuro_psychologist_backend') {
                        sh '''
                            docker stop neuroapp || true
                            docker rm neuroapp || true
                            docker build -t neuroapp .

                            # –ó–∞–ø—É—Å–∫–∞–µ–º –≤ —Å–µ—Ç–µ–≤–æ–º —Ä–µ–∂–∏–º–µ host
                            docker run -d --name neuroapp \
                            --network host \
                            -e YANDEX_API_KEY=''' + "${env.AI_API_KEY}" + ''' \
                            -e AI_FOLDER_ID=''' + "${env.AI_FOLDER_ID}" + ''' \
                            -e AI_KEY_ID=''' + "${env.AI_KEY_ID}" + ''' \
                            -e SERVER_PORT=8081 \
                            neuroapp
                        '''
                    }
                }
            }
            post {
                success {
                    echo '‚úÖ Application successfully deployed!'
                    echo 'üåê External URL: http://158.160.203.252:8081'
                    echo 'üìä Health check: http://158.160.203.252:8081/actuator/health'

                    sh '''
                        sleep 15
                        curl -f http://158.160.203.252:8081/actuator/health || echo "Health check failed"
                    '''
                }
            }
        }
    }

    post {
        always {
            echo 'Pipeline execution completed.'
        }
        success {
            echo '‚úÖ Pipeline executed successfully!'
        }
        failure {
            echo '‚ùå Pipeline failed! Check the logs for details.'
        }
        unstable {
            echo '‚ö†Ô∏è Pipeline is unstable! Some tests may have failed.'
        }
    }
}