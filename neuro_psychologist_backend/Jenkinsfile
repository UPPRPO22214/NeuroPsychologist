pipeline {
    agent any
    
    environment {
        MAVEN_OPTS = '-Xmx1024m'
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo 'Checking out source code...'
                checkout scm
                echo 'Making Maven wrapper executable...'
                sh 'chmod +x neuro_psychologist_backend/mvnw'
            }
        }
        
        stage('Build Info') {
            steps {
                echo 'Displaying build information...'
                sh 'java -version'
                dir('neuro_psychologist_backend') {
                    sh './mvnw -version'
                }
                sh 'echo "Building neuro_psychologist_backend version: 0.0.1-SNAPSHOT"'
            }
        }
        
        stage('Clean & Compile') {
            steps {
                echo 'Cleaning and compiling the project...'
                dir('neuro_psychologist_backend') {
                    sh './mvnw clean compile'
                }
            }
        }
        
        stage('Test') {
            steps {
                echo 'Running unit tests...'
                dir('neuro_psychologist_backend') {
                    sh './mvnw test'
                }
            }
            post {
                always {
                    junit testResults: 'neuro_psychologist_backend/target/surefire-reports/*.xml', allowEmptyResults: true
                    archiveArtifacts artifacts: 'neuro_psychologist_backend/target/surefire-reports/**/*', allowEmptyArchive: true
                }
            }
        }
        
        stage('Package') {
            steps {
                echo 'Packaging the application...'
                dir('neuro_psychologist_backend') {
                    sh './mvnw package -DskipTests'
                }
            }
            post {
                success {
                    archiveArtifacts artifacts: 'neuro_psychologist_backend/target/*.jar', fingerprint: true
                }
            }
        }
        
        stage('Verify') {
            steps {
                echo 'Verifying the build...'
                dir('neuro_psychologist_backend') {
                    sh 'ls -la target/'
                    sh 'file target/*.jar || echo "JAR file verification skipped"'
                }
            }
        }
        
        stage('Deploy Locally') {
            when {
                anyOf {
                    branch 'main'
                    branch 'develop'
                }
            }
            steps {
                echo 'Deploying application locally...'
                script {
                    dir('neuro_psychologist_backend') {
                        sh '''
                            # –°–æ–∑–¥–∞—ë–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
                            mkdir -p /var/jenkins_home/apps/neuropsychologist
                            
                            # –ö–æ–ø–∏—Ä—É–µ–º –Ω–æ–≤—ã–π JAR —Ñ–∞–π–ª
                            cp target/neuro_psychologist_backend-0.0.1-SNAPSHOT.jar /var/jenkins_home/apps/neuropsychologist/app.jar
                            
                            # –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –ø–æ—Ä—Ç—É 8081
                            cd /var/jenkins_home/apps/neuropsychologist
                            echo "Starting application on port 8081..."
                            
                            # –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –¥–ª—è –≤–Ω–µ—à–Ω–µ–≥–æ –¥–æ—Å—Ç—É–ø–∞
                            java -jar app.jar \
                                --server.port=8081 \
                                --server.address=0.0.0.0 \
                                --management.endpoints.web.exposure.include=health,info \
                                --management.endpoint.health.show-details=always \
                                > app.log 2>&1 &
                            APP_PID=$!
                            echo "Application started with PID: $APP_PID on port 8081"
                            echo "External URL: http://158.160.203.252:8081"
                            
                            # –ñ–¥—ë–º –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
                            echo "Waiting for application to start..."
                            sleep 20
                            
                            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—Å—Ç–∏–ª–æ—Å—å
                            for i in {1..10}; do
                                if curl -f http://localhost:8081/actuator/health 2>/dev/null; then
                                    echo "‚úÖ Application is healthy on port 8081!"
                                    echo "üåê External access: http://158.160.203.252:8081"
                                    echo "üìä Health check: http://158.160.203.252:8081/actuator/health"
                                    exit 0
                                elif [ $i -eq 10 ]; then
                                    echo "‚ùå Application failed to start"
                                    echo "=== Application logs ==="
                                    cat /var/jenkins_home/apps/neuropsychologist/app.log
                                    exit 1
                                else
                                    echo "Attempt $i/10: Application not ready yet, waiting..."
                                    sleep 5
                                fi
                            done
                        '''
                    }
                }
            }
            post {
                success {
                    echo '‚úÖ Application successfully deployed!'
                    echo 'üåê External URL: http://158.160.203.252:8081'
                    echo 'üìä Health check: http://158.160.203.252:8081/actuator/health'
                }
                failure {
                    echo '‚ùå Deployment failed! Check application logs:'
                    sh 'tail -100 /var/jenkins_home/apps/neuropsychologist/app.log || echo "No log file found"'
                }
            }
        }
    }
    
    post {
        always {
            echo 'Pipeline execution completed.'
        }
        
        success {
            echo '‚úÖ Pipeline executed successfully!'
        }
        
        failure {
            echo '‚ùå Pipeline failed! Check the logs for details.'
        }
        
        unstable {
            echo '‚ö†Ô∏è Pipeline is unstable! Some tests may have failed.'
        }
    }
}