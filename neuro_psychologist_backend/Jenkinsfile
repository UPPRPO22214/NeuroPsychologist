Deploy pipeline {
    agent any
    
    environment {
        MAVEN_OPTS = '-Xmx1024m'
        // AI API Configuration - —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —ç—Ç–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ Jenkins
        AI_API_KEY = credentials('ai-api-key')
        AI_FOLDER_ID = credentials('ai-folder-id')
        AI_KEY_ID = credentials('ai-key-id')
        SERVER_PORT = '8081'
        DOCKER_IMAGE_NAME = 'neuro-psychologist-backend'
        DOCKER_CONTAINER_NAME = 'neuro-psychologist-app'
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo 'Checking out source code...'
                checkout scm
                echo 'Making Maven wrapper executable...'
                sh 'chmod +x neuro_psychologist_backend/mvnw'
            }
        }
        
        stage('Build Info') {
            steps {
                echo 'Displaying build information...'
                sh 'java -version'
                dir('neuro_psychologist_backend') {
                    sh './mvnw -version'
                }
                sh 'echo "Building neuro_psychologist_backend version: 0.0.1-SNAPSHOT"'
                sh 'docker --version'
            }
        }
        
        stage('Clean & Compile') {
            steps {
                echo 'Cleaning and compiling the project...'
                dir('neuro_psychologist_backend') {
                    sh './mvnw clean compile'
                }
            }
        }
        
        stage('Test') {
            steps {
                echo 'Running unit tests...'
                dir('neuro_psychologist_backend') {
                    sh './mvnw test'
                }
            }
            post {
                always {
                    junit testResults: 'neuro_psychologist_backend/target/surefire-reports/*.xml', allowEmptyResults: true
                    archiveArtifacts artifacts: 'neuro_psychologist_backend/target/surefire-reports/**/*', allowEmptyArchive: true
                }
            }
        }
        
        stage('Package') {
            steps {
                echo 'Packaging the application...'
                dir('neuro_psychologist_backend') {
                    sh './mvnw package -DskipTests'
                }
            }
            post {
                success {
                    archiveArtifacts artifacts: 'neuro_psychologist_backend/target/*.jar', fingerprint: true
                }
            }
        }
        
        stage('Build Docker Image') {
            steps {
                echo 'Building Docker image...'
                script {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ Dockerfile
                    def dockerfileExists = fileExists 'neuro_psychologist_backend/Dockerfile'
                    if (!dockerfileExists) {
                        echo 'Dockerfile not found, creating default Dockerfile...'
                        writeFile file: 'neuro_psychologist_backend/Dockerfile', text: '''
FROM openjdk:17-jdk-slim
WORKDIR /app
COPY target/*.jar app.jar
EXPOSE 8081
ENTRYPOINT ["java", "-jar", "app.jar"]
'''
                    }
                    
                    dir('neuro_psychologist_backend') {
                        sh """
                            docker build -t ${env.DOCKER_IMAGE_NAME}:latest -t ${env.DOCKER_IMAGE_NAME}:${env.BUILD_NUMBER} .
                        """
                    }
                }
            }
        }
        
        stage('Deploy to Docker') {
            steps {
                echo 'Deploying application to Docker container...'
                script {
                    def currentBranch = env.BRANCH_NAME
                    if (currentBranch == 'main' || currentBranch == 'develop') {
                        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏ —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, –µ—Å–ª–∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
                        sh """
                            docker stop ${env.DOCKER_CONTAINER_NAME} || true
                            docker rm ${env.DOCKER_CONTAINER_NAME} || true
                        """
                        
                        // –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è
                        sh """
                            docker run -d \\
                                --name ${env.DOCKER_CONTAINER_NAME} \\
                                -p ${env.SERVER_PORT}:8081 \\
                                -e YANDEX_API_KEY="${env.AI_API_KEY}" \\
                                -e AI_FOLDER_ID="${env.AI_FOLDER_ID}" \\
                                -e AI_KEY_ID="${env.AI_KEY_ID}" \\
                                -e SERVER_PORT=8081 \\
                                --restart unless-stopped \\
                                ${env.DOCKER_IMAGE_NAME}:latest
                        """
                        
                        // –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ –¥–ª—è —Å—Ç–∞—Ä—Ç–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
                        sleep time: 30, unit: 'SECONDS'
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø—É—â–µ–Ω
                        sh "docker ps | grep ${env.DOCKER_CONTAINER_NAME}"
                    } else {
                        echo "Skipping deployment for branch: ${currentBranch}"
                    }
                }
            }
            post {
                success {
                    echo '‚úÖ Application successfully deployed to Docker!'
                    echo 'üåê External URL: http://158.160.203.252:8081'
                    echo 'üìä Health check: http://158.160.203.252:8081/actuator/health'
                    
                    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
                    script {
                        try {
                            sh 'curl -f http://localhost:8081/actuator/health || echo "Health check failed but continuing..."'
                        } catch (Exception e) {
                            echo "Health check failed: ${e.message}"
                        }
                    }
                }
                failure {
                    echo '‚ùå Docker deployment failed!'
                    // –õ–æ–≥–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
                    sh "docker logs ${env.DOCKER_CONTAINER_NAME} --tail 50 || true"
                }
            }
        }
        
        stage('Cleanup') {
            steps {
                echo 'Cleaning up old Docker images...'
                script {
                    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–∑—ã, –æ—Å—Ç–∞–≤–ª—è—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5
                    sh '''
                        docker images ${env.DOCKER_IMAGE_NAME} --format "table {{.Tag}}" | tail -n +2 | sort -V | head -n -5 | \
                        xargs -I {} docker rmi ${env.DOCKER_IMAGE_NAME}:{} 2>/dev/null || true
                    '''
                }
            }
        }
    }
    
    post {
        always {
            echo 'Pipeline execution completed.'
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–≥–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –ø—Ä–∏ –Ω–µ—É–¥–∞—á–Ω–æ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏
            script {
                if (currentBuild.result == 'FAILURE') {
                    sh "docker logs ${env.DOCKER_CONTAINER_NAME} --tail 100 > docker_debug.log || true"
                    archiveArtifacts artifacts: 'docker_debug.log', allowEmptyArchive: true
                }
            }
        }
        
        success {
            echo '‚úÖ Pipeline executed successfully!'
        }
        
        failure {
            echo '‚ùå Pipeline failed! Check the logs for details.'
        }
        
        unstable {
            echo '‚ö†Ô∏è Pipeline is unstable! Some tests may have failed.'
        }
    }
}